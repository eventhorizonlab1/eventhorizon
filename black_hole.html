<!--
  Event Horizon - Main Page
  Version restaur√©e et augment√©e pour integration Anime.js
-->
<!DOCTYPE html>
<html lang="fr">

<head>
  <!-- Meta & d√©pendances -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Event Horizon - Simulation de Trou Noir</title>

  <!-- SEO -->
  <meta name="description" content="Event Horizon : d√©couvrez les coulisses de l'industrie spatiale europ√©enne avec nos vid√©os, articles et analyses exclusives sur Ariane 6, les satellites et l'√©cosyst√®me toulousain.">
  <meta name="keywords" content="espace, industrie spatiale, Ariane 6, ESA, satellites, Toulouse, a√©ronautique">

  <!-- Open Graph pour les r√©seaux sociaux -->
  <meta property="og:title" content="Event Horizon - L'actualit√© spatiale europ√©enne">
  <meta property="og:description" content="Dans les coulisses de l'industrie spatiale europ√©enne">
  <meta property="og:image" content="https://eventhorizon.space/assets/og-image-black-hole.jpg">
  <meta property="og:url" content="https://eventhorizon.space/black_hole.html">
  <meta property="og:type" content="website">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Event Horizon">
  <meta name="twitter:description" content="L'actualit√© spatiale europ√©enne">
  <meta name="twitter:image" content="https://eventhorizon.space/assets/twitter-image-black-hole.jpg">

  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "NewsMediaOrganization",
    "name": "Event Horizon",
    "url": "https://eventhorizon.space/black_hole.html",
    "logo": "https://eventhorizon.space/assets/logo.png",
    "description": "L'actualit√© de l'industrie spatiale europ√©enne",
    "sameAs": [
      "https://youtube.com/@eventhorizon",
      "https://linkedin.com/company/eventhorizon",
      "https://twitter.com/eventhorizon"
    ]
  }
  </script>

  <!-- Tailwind + Fonts -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.8.2/dist/alpine.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'text-primary': '#111111',
            'text-secondary': '#666666',
            'border-light': '#E5E5E5',
            'dark-bg': '#000000',
            'dark-text-primary': '#FFFFFF',
            'dark-text-secondary': '#A0A0A0',
          },
          fontFamily: {
            sans: ["Inter", "sans-serif"],
          },
        },
      },
    };
  </script>

  <style type="text/tailwindcss">
    @layer base {
      html {
        @apply scroll-smooth;
      }
      body {
        @apply bg-white font-sans text-text-primary antialiased dark:bg-dark-bg dark:text-dark-text-primary;
      }
    }

    .dots-grid {
      position: absolute;
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(20, 1fr);
      grid-template-rows: repeat(20, 1fr);
      gap: 0;
    }

    .dot {
      width: 4px;
      height: 4px;
      background: rgba(99, 102, 241, 0.6);
      border-radius: 50%;
      place-self: center;
    }

    html:not(.dark) .dot {
      background: rgba(99, 102, 241, 0.4);
    }
  </style>
  <style>
    main {
      position: relative;
      width: 100%;
      height: 85vh;
    }
    /* body { margin: 0; padding: 0; overflow: hidden; background-color: #000000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; } */
    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }
    #controls { position: absolute; top: 20px; left: 20px; background: rgba(0, 0, 0, 0.7); padding: 20px; border-radius: 10px; color: white; min-width: 250px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    #controls h3 { margin-top: 0; color: #ffa500; }
    .control-group { margin: 15px 0; }
    .control-group label { display: block; margin-bottom: 5px; font-size: 12px; color: #ccc; }
    .control-group input[type="range"] { width: 100%; }
    .control-group .value { display: inline-block; float: right; color: #ffa500; }
    #info { position: absolute; bottom: 20px; left: 20px; color: rgba(255, 255, 255, 0.6); font-size: 11px; }
    #fps { position: absolute; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.7); padding: 10px 15px; border-radius: 5px; color: #ffa500; font-size: 14px; font-weight: bold; backdrop-filter: blur(10px); }
    button { background: #ffa500; border: none; padding: 8px 15px; border-radius: 5px; color: black; cursor: pointer; font-weight: bold; margin-top: 10px; width: 100%; }
    button:hover { background: #ff8c00; }
  </style>

  <!-- Simple analytics sans cookies (RGPD-friendly) -->
  <script>
    window.plausible = window.plausible || function() {
      (window.plausible.q = window.plausible.q || []).push(arguments)
    };
  </script>
  <script defer data-domain="eventhorizon.space"
          src="https://plausible.io/js/script.js"></script>
</head>

<body class="overflow-x-hidden">
  <!-- Anime.js and site script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="documentation.js" defer></script>

  <div class="min-h-screen w-full">
    <div class="relative z-10 mx-auto max-w-7xl px-8 py-6 md:px-12 md:py-8">

      <!-- Header -->
      <header class="w-full" x-data="{ open: false }">
        <nav class="flex items-center justify-between text-sm">
          <div class="logo-container">
            <a class="flex items-center gap-x-2 text-2xl font-bold tracking-tight text-black dark:text-white" href="index.html" aria-label="Event Horizon Home">
              <svg class="h-8 w-8" viewBox="0 0 100 100" xmlns="http://www.w.org/2000/svg">
                <path d="M50,10 A40,40 0 1,1 50,90 A40,40 0 1,1 50,10" fill="none" stroke="currentColor" stroke-width="8"/>
              </svg>
              <span>Event Horizon</span>
            </a>
          </div>
          <div class="hidden items-center gap-x-8 text-text-primary dark:text-dark-text-primary md:flex">
            <a class="transition-colors hover:text-black dark:hover:text-white" href="index.html#videos" data-i18n-key="nav.videos">Vid√©os</a>
            <a class="transition-colors hover:text-black dark:hover:text-white" href="index.html#articles" data-i18n-key="nav.articles">Articles</a>
            <a class="transition-colors hover:text-black dark:hover:text-white" href="index.html#ecosysteme" data-i18n-key="nav.ecosystem">L'√âcosyst√®me Toulousain</a>
            <a class="transition-colors hover:text-black dark:hover:text-white" href="black_hole.html" data-i18n-key="nav.black_hole">Trou Noir</a>
          </div>
          <div class="flex items-center">
            <div class="language-switcher hidden items-center text-sm font-medium md:flex">
              <a href="#" data-lang="fr" class="px-2 py-1 rounded-md">FR</a>
              <span class="text-gray-300 dark:text-white/30">/</span>
              <a href="#" data-lang="en" class="px-2 py-1 rounded-md">EN</a>
            </div>
            <button id="theme-toggle"
              class="ml-4 hidden items-center justify-center rounded-full p-2 text-text-primary transition-colors hover:bg-gray-100 dark:text-dark-text-primary dark:hover:bg-gray-800 md:flex"
              type="button" aria-label="Basculer le th√®me">
              <span class="material-symbols-outlined">light_mode</span>
            </button>
            <button @click="open = !open" class="ml-4 md:hidden" type="button" aria-label="Ouvrir le menu">
              <span class="material-symbols-outlined text-black dark:text-white">menu</span>
            </button>
            <a class="border border-black bg-black px-4 py-2 text-xs font-semibold uppercase tracking-wider text-white transition-colors hover:bg-white hover:text-black dark:border-white dark:bg-white dark:text-black dark:hover:bg-black dark:hover:text-white ml-4"
               href="https://www.youtube.com" rel="noopener noreferrer" target="_blank" data-i18n-key="subscribe_button">S'abonner</a>
          </div>
        </nav>

        <!-- Mobile menu -->
        <div x-show="open" class="md:hidden">
          <div class="fixed inset-0 z-20 bg-black/40 backdrop-blur-sm" @click="open = false"></div>
          <div class="fixed inset-y-0 right-0 z-30 w-full max-w-sm bg-white dark:bg-dark-bg" @click.away="open = false">
            <div class="flex h-full flex-col">
              <div class="flex items-center justify-between p-6">
                <a class="text-2xl font-bold tracking-tight text-black dark:text-white" href="index.html">Event Horizon</a>
                <div class="flex items-center">
                  <button id="theme-toggle-mobile" class="mr-4 flex items-center justify-center rounded-full p-2 text-text-primary transition-colors hover:bg-gray-100 dark:text-dark-text-primary dark:hover:bg-gray-800" type="button">
                    <span class="material-symbols-outlined">light_mode</span>
                  </button>
                  <button @click="open = false" type="button" aria-label="Fermer">
                    <span class="material-symbols-outlined text-black dark:text-white">close</span>
                  </button>
                </div>
              </div>
              <div class="flex-grow p-6">
                <nav class="flex flex-col items-start gap-y-4 text-lg">
                  <a class="transition-colors hover:text-black dark:text-dark-text-primary dark:hover:text-white" href="index.html#videos" @click="open = false" data-i18n-key="nav.videos">Vid√©os</a>
                  <a class="transition-colors hover:text-black dark:text-dark-text-primary dark:hover:text-white" href="index.html#articles" @click="open = false" data-i18n-key="nav.articles">Articles</a>
                  <a class="transition-colors hover:text-black dark:text-dark-text-primary dark:hover:text-white" href="index.html#ecosysteme" @click="open = false" data-i18n-key="nav.ecosystem">L'√âcosyst√®me Toulousain</a>
                  <a class="transition-colors hover:text-black dark:text-dark-text-primary dark:hover:text-white" href="black_hole.html" data-i18n-key="nav.black_hole">Trou Noir</a>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Main content -->
      <main class="w-full">
        <div id="controls">
          <h3>‚ö´ Black Hole Controls</h3>
          <div class="control-group">
            <label>Rotation Speed <span class="value" id="rotSpeed">1.0x</span></label>
            <input type="range" id="rotationSpeed" min="0" max="3" step="0.1" value="1.0">
          </div>
          <div class="control-group">
            <label>Bloom Intensity <span class="value" id="bloomVal">1.5</span></label>
            <input type="range" id="bloomIntensity" min="0" max="3" step="0.1" value="1.5">
          </div>
          <div class="control-group">
            <label>Lensing Strength <span class="value" id="lensVal">0.8</span></label>
            <input type="range" id="lensingStrength" min="0" max="2" step="0.1" value="0.8">
          </div>
          <div class="control-group">
            <label>Disk Brightness <span class="value" id="diskVal">15.0</span></label>
            <input type="range" id="diskBrightness" min="5" max="30" step="1" value="15">
          </div>
          <div class="control-group">
            <label>Presets</label>
            <div style="display: flex; justify-content: space-between;">
              <button class="preset-btn" data-preset="gentle">Gentle</button>
              <button class="preset-btn" data-preset="intense">Intense</button>
              <button class="preset-btn" data-preset="realistic">Realistic</button>
            </div>
          </div>
          <button id="resetBtn">Reset Camera</button>
        </div>
        <div id="fps">FPS: 60</div>
        <div id="info">
          üñ±Ô∏è Drag to rotate | üîç Scroll to zoom | 100,000 particles
        </div>

        <div id="info-panel" class="absolute bottom-20 left-20 bg-black/80 p-6 rounded-lg max-w-md">
          <h4 class="text-xl font-bold mb-3">Qu'est-ce qu'un trou noir ?</h4>
          <p class="text-sm mb-4">
            Un trou noir est une r√©gion de l'espace dont le champ gravitationnel
            est si intense que rien ne peut s'en √©chapper, pas m√™me la lumi√®re.
          </p>
          <button onclick="document.getElementById('info-panel').classList.add('hidden')"
                  class="text-orange-500 hover:text-orange-400">
            Fermer
          </button>
        </div>

        <script type="importmap">
          {
            "imports": {
              "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
              "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
          }
        </script>
      </main>
    </div>

    <!-- Footer -->
    <footer class="w-full bg-black text-white">
      <div class="mx-auto max-w-7xl px-8 py-12 md:px-12 md:py-16">
        <div class="flex flex-col items-center justify-between gap-y-8 pb-8 md:flex-row md:items-center">
          <div class="flex flex-col items-center gap-y-4 text-center md:items-start md:text-left">
            <a class="text-2xl font-bold tracking-tight text-white" href="#">Event Horizon</a>
            <nav class="flex flex-wrap justify-center gap-x-6 gap-y-2 text-sm text-gray-400 md:justify-start">
              <a class="transition-colors hover:text-white quick-link" href="mailto:contact@eventhorizon.fr" data-i18n-key="footer.contact">contact@eventhorizon.fr</a>
            </nav>
          </div>

          <div class="flex items-center gap-x-4">
            <a class="text-gray-400 transition-colors hover:text-white" href="#" title="YouTube">
              <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"></path>
              </svg>
            </a>
            <a class="text-gray-400 transition-colors hover:text-white" href="#" title="LinkedIn">
              <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.225 0z"></path>
              </svg>
            </a>
            <a class="text-gray-400 transition-colors hover:text-white" href="#" title="Twitter">
              <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.22-1.95-.55v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.94.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"></path>
              </svg>
            </a>
          </div>

        </div>

        <div class="flex flex-col items-center justify-between gap-y-4 border-t border-gray-800 pt-8 text-center text-sm text-gray-400 md:flex-row md:text-left">
          <p data-i18n-key="footer.rights">¬© 2023 Event Horizon. Tous droits r√©serv√©s.</p>
          <a class="transition-colors hover:text-white quick-link" href="#" data-i18n-key="footer.privacy">Politique de Confidentialit√©</a>
        </div>
      </div>
    </footer>

  </div>
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';
    // ----------------------------------------------------------------- // PROCEDURAL SMOKE TEXTURE GENERATOR // -----------------------------------------------------------------
    function generateSmokeTexture() {
      const size = 256;
      const canvas = document.createElement('canvas');
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext('2d');
      const gradient = ctx.createRadialGradient(size / 2, size / 2, 0, size / 2, size / 2, size / 2);
      gradient.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
      gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.3)');
      gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, size, size);
      return new THREE.CanvasTexture(canvas);
    }
    const SMOKE_TEXTURE = generateSmokeTexture();
    // ----------------------------------------------------------------- // EMBEDDED GLSL SHADERS // -----------------------------------------------------------------
    const DebrisVertexShader = ` uniform float u_time; attribute float a_scale; attribute vec3 a_color; attribute float a_angular_velocity; attribute float a_inward_velocity; attribute float a_start_radius; varying vec3 v_color; varying float v_alpha; void main() { v_color = a_color; float angle = u_time * a_angular_velocity; float radius = a_start_radius - u_time * a_inward_velocity; if (radius < 15.0) { v_alpha = max(0.0, (radius - 10.0) / 5.0); radius = 15.0; } else { v_alpha = 1.0; } vec3 new_pos; new_pos.x = radius * cos(angle + position.x); new_pos.y = position.y; new_pos.z = radius * sin(angle + position.x); vec4 mv_position = modelViewMatrix * vec4(new_pos, 1.0); gl_Position = projectionMatrix * mv_position; float size = a_scale * (150.0 / -mv_position.z); gl_PointSize = max(1.0, size); } `;
    const DebrisFragmentShader = ` varying vec3 v_color; varying float v_alpha; void main() { float dist = length(gl_PointCoord - vec2(0.5)); if (dist > 0.5) { discard; } gl_FragColor = vec4(v_color, v_alpha * (1.0 - dist * 2.0)); } `;
    const AccretionDiskVertexShader = ` varying vec2 v_uv; void main() { v_uv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); } `;
    const AccretionDiskFragmentShader = ` uniform float u_time; uniform float u_brightness; varying vec2 v_uv; float random(vec2 st) { return fract(sin(dot(st.xy, vec2(12.9898, 78.233))) * 43758.5453123); } float fbm(vec2 st) { float value = 0.0; float amplitude = 0.5; for (int i = 0; i < 6; i++) { value += amplitude * random(st); st *= 2.0; amplitude *= 0.5; } return value; } void main() { vec2 to_center = vec2(0.5) - v_uv; float radius = length(to_center) * 2.0; float angle = atan(to_center.y, to_center.x); if (radius > 1.0 || radius < 0.01) { discard; } float noise = fbm(vec2(angle * 3.0, radius * 1.0 - u_time * 0.1)); float rotation = u_time * (1.0 / (radius + 0.1)) * 0.2; float turbulent_angle = angle + rotation + noise * 0.5; float strands = pow(sin(turbulent_angle * 12.0), 10.0); vec3 color = mix(vec3(1.0, 0.5, 0.0), vec3(1.0, 0.9, 0.0), noise); color += strands * 0.5 + noise * 0.3; float edge_fade = smoothstep(0.0, 0.2, radius) * (1.0 - smoothstep(0.8, 1.0, radius)); color *= edge_fade; gl_FragColor = vec4(color * u_brightness, 1.0); } `;
    const LensingVertexShader = ` varying vec2 v_uv; void main() { v_uv = uv; gl_Position = vec4(position.xy, 0.0, 1.0); } `;
    const LensingFragmentShader = ` uniform sampler2D t_background; uniform vec2 u_resolution; uniform float u_lensing_strength; varying vec2 v_uv; const float SCHWARZSCHILD_RADIUS = 0.2; const float LENSING_RADIUS = 0.6; void main() { vec2 uv_center = v_uv - 0.5; uv_center.x *= u_resolution.x / u_resolution.y; float dist = length(uv_center); if (dist < SCHWARZSCHILD_RADIUS) { gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0); return; } float falloff = 1.0 - smoothstep(SCHWARZSCHILD_RADIUS, LENSING_RADIUS, dist); float bend = u_lensing_strength * falloff * (SCHWARZSCHILD_RADIUS / dist); vec2 bent_uv_center = uv_center + (uv_center / dist) * bend; bent_uv_center.x /= (u_resolution.x / u_resolution.y); vec2 final_uv = bent_uv_center + 0.5; vec4 background = texture2D(t_background, final_uv); if (dist > LENSING_RADIUS) { background = texture2D(t_background, v_uv); } gl_FragColor = background; } `;

    const PRESETS = {
      'gentle': { rotationSpeed: 0.5, bloomIntensity: 1.0, lensingStrength: 0.5 },
      'intense': { rotationSpeed: 2.0, bloomIntensity: 2.5, lensingStrength: 1.5 },
      'realistic': { rotationSpeed: 1.0, bloomIntensity: 1.5, lensingStrength: 0.8 }
    };

    // ----------------------------------------------------------------- // MAIN APPLICATION CLASS // -----------------------------------------------------------------
    class BlackHoleSimulation {
      constructor() { // Sc√®nes s√©par√©es pour un meilleur contr√¥le du pipeline
        const container = document.querySelector('main');
        this.backgroundScene = new THREE.Scene(); // D√©bris (pour lensing)
        this.scene = new THREE.Scene(); // Disque + gaz
        this.lensingScene = new THREE.Scene(); // Quad de lensing
        this.camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        this.camera.position.set(0, 30, 60);
        this.camera.lookAt(0, 0, 0);
        this.renderer = new THREE.WebGLRenderer({
          antialias: true
        });
        this.renderer.setSize(container.clientWidth, container.clientHeight);
        this.renderer.setPixelRatio(window.devicePixelRatio);
        this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
        this.renderer.toneMappingExposure = 1.0;
        container.appendChild(this.renderer.domElement);
        this.clock = new THREE.Clock();
        this.rotationSpeedMultiplier = 1.0; // FPS counter
        this.frameCount = 0;
        this.lastFPSUpdate = 0; // Render target pour le fond (d√©bris)
        this.backgroundRenderTarget = new THREE.WebGLRenderTarget(container.clientWidth * window.devicePixelRatio, container.clientHeight * window.devicePixelRatio, {
          type: THREE.HalfFloatType
        });
        this.container = container;
        this.setupControls();
        this.setupLensing();
        this.setupAccretionDisk();
        this.setupDebrisField();
        this.setupGasClouds();
        this.setupPostProcessing();
        this.setupUI();
        window.addEventListener('resize', this.onWindowResize.bind(this));
        this.animate();
      }
      setupControls() {
        this.controls = new OrbitControls(this.camera, this.renderer.domElement);
        this.controls.enableDamping = true;
        this.controls.dampingFactor = 0.05;
        this.controls.minDistance = 20;
        this.controls.maxDistance = 200;
      }
      setupLensing() {
        this.lensingMaterial = new THREE.ShaderMaterial({
          uniforms: {
            t_background: {
              value: this.backgroundRenderTarget.texture
            },
            u_resolution: {
              value: new THREE.Vector2(window.innerWidth, window.innerHeight)
            },
            u_lensing_strength: {
              value: 0.8
            }
          },
          vertexShader: LensingVertexShader,
          fragmentShader: LensingFragmentShader
        });
        this.lensingQuad = new THREE.Mesh(new THREE.PlaneGeometry(2, 2), this.lensingMaterial);
        this.lensingScene.add(this.lensingQuad);
      }
      setupAccretionDisk() {
        const diskGeometry = new THREE.RingGeometry(15.1, 35, 128);
        this.accretionDiskMaterial = new THREE.ShaderMaterial({
          uniforms: {
            u_time: {
              value: 0.0
            },
            u_brightness: {
              value: 15.0
            }
          },
          vertexShader: AccretionDiskVertexShader,
          fragmentShader: AccretionDiskFragmentShader,
          side: THREE.DoubleSide,
          transparent: true,
          blending: THREE.AdditiveBlending,
          depthWrite: false
        });
        this.accretionDisk = new THREE.Mesh(diskGeometry, this.accretionDiskMaterial);
        this.accretionDisk.rotation.x = Math.PI / 2;
        this.scene.add(this.accretionDisk);
      }
      setupDebrisField() {
        const PARTICLE_COUNT = 100000;
        const positions = [];
        const scales = [];
        const colors = [];
        const angularVelocities = [];
        const inwardVelocities = [];
        const startRadii = [];
        for (let i = 0; i < PARTICLE_COUNT; i++) {
          const radius = THREE.MathUtils.randFloat(10, 500);
          const angle = THREE.MathUtils.randFloat(0, Math.PI * 2);
          positions.push(radius * Math.cos(angle), THREE.MathUtils.randFloatSpread(10), radius * Math.sin(angle));
          scales.push(THREE.MathUtils.randFloat(0.5, 1.5));
          const color = new THREE.Color();
          const warmth = 1.0 - Math.min(radius / 300, 1.0);
          color.setRGB(1.0, 0.8 + warmth * 0.2, 0.8 + warmth * 0.2);
          colors.push(color.r, color.g, color.b);
          startRadii.push(radius);
          angularVelocities.push(THREE.MathUtils.randFloat(0.01, 0.05) / (radius * 0.1));
          inwardVelocities.push(Math.random() > 0.95 ? THREE.MathUtils.randFloat(0.5, 2.0) : 0.0);
        }
        const geometry = new THREE.BufferGeometry();
        geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        geometry.setAttribute('a_scale', new THREE.Float32BufferAttribute(scales, 1));
        geometry.setAttribute('a_color', new THREE.Float32BufferAttribute(colors, 3));
        geometry.setAttribute('a_start_radius', new THREE.Float32BufferAttribute(startRadii, 1));
        geometry.setAttribute('a_angular_velocity', new THREE.Float32BufferAttribute(angularVelocities, 1));
        geometry.setAttribute('a_inward_velocity', new THREE.Float32BufferAttribute(inwardVelocities, 1));
        this.debrisMaterial = new THREE.ShaderMaterial({
          uniforms: {
            u_time: {
              value: 0.0
            }
          },
          vertexShader: DebrisVertexShader,
          fragmentShader: DebrisFragmentShader,
          transparent: true,
          blending: THREE.AdditiveBlending,
          depthWrite: false
        });
        this.debrisField = new THREE.Points(geometry, this.debrisMaterial);
        this.backgroundScene.add(this.debrisField);
      }
      setupGasClouds() {
        const PARTICLE_COUNT = 500;
        const positions = [];
        for (let i = 0; i < PARTICLE_COUNT; i++) {
          positions.push(THREE.MathUtils.randFloatSpread(200), THREE.MathUtils.randFloatSpread(5), THREE.MathUtils.randFloatSpread(200));
        }
        const geometry = new THREE.BufferGeometry();
        geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        const material = new THREE.PointsMaterial({
          map: SMOKE_TEXTURE,
          size: 50,
          blending: THREE.AdditiveBlending,
          transparent: true,
          opacity: 0.2,
          depthWrite: false
        });
        this.gasClouds = new THREE.Points(geometry, material);
        this.gasCloudGroup = new THREE.Group();
        this.gasCloudGroup.add(this.gasClouds);
        this.scene.add(this.gasCloudGroup);
      }
      setupPostProcessing() {
        const renderTarget = new THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight, {
          type: THREE.HalfFloatType
        });
        this.composer = new EffectComposer(this.renderer, renderTarget); // Pipeline optimis√© : // 1. Lensing pass (lit la texture de d√©bris pr√©-rendue)
        const lensingPass = new RenderPass(this.lensingScene, this.camera);
        this.composer.addPass(lensingPass); // 2. Sc√®ne principale par-dessus (disque + gaz)
        const renderPass = new RenderPass(this.scene, this.camera);
        renderPass.clear = false; // Ne pas effacer le lensing
        this.composer.addPass(renderPass); // 3. Bloom (principalement sur le disque)
        this.bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 1.0);
        this.composer.addPass(this.bloomPass); // 4. Output pass (tone mapping)
        const outputPass = new OutputPass();
        this.composer.addPass(outputPass);
      }
      setupUI() {
        document.getElementById('rotationSpeed').addEventListener('input', (e) => {
          this.rotationSpeedMultiplier = parseFloat(e.target.value);
          document.getElementById('rotSpeed').textContent = e.target.value + 'x';
        });
        document.getElementById('bloomIntensity').addEventListener('input', (e) => {
          this.bloomPass.strength = parseFloat(e.target.value);
          document.getElementById('bloomVal').textContent = e.target.value;
        });
        document.getElementById('lensingStrength').addEventListener('input', (e) => {
          this.lensingMaterial.uniforms.u_lensing_strength.value = parseFloat(e.target.value);
          document.getElementById('lensVal').textContent = e.target.value;
        });
        document.getElementById('diskBrightness').addEventListener('input', (e) => {
          this.accretionDiskMaterial.uniforms.u_brightness.value = parseFloat(e.target.value);
          document.getElementById('diskVal').textContent = e.target.value;
        });
        document.getElementById('resetBtn').addEventListener('click', () => {
          this.camera.position.set(0, 30, 60);
          this.controls.target.set(0, 0, 0);
          this.controls.update();
        });

        document.querySelectorAll('.preset-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const presetName = e.target.dataset.preset;
            const preset = PRESETS[presetName];
            if (preset) {
              this.applyPreset(preset);
            }
          });
        });
      }

      applyPreset(preset) {
        document.getElementById('rotationSpeed').value = preset.rotationSpeed;
        this.rotationSpeedMultiplier = preset.rotationSpeed;
        document.getElementById('rotSpeed').textContent = preset.rotationSpeed + 'x';

        document.getElementById('bloomIntensity').value = preset.bloomIntensity;
        this.bloomPass.strength = preset.bloomIntensity;
        document.getElementById('bloomVal').textContent = preset.bloomIntensity;

        document.getElementById('lensingStrength').value = preset.lensingStrength;
        this.lensingMaterial.uniforms.u_lensing_strength.value = preset.lensingStrength;
        document.getElementById('lensVal').textContent = preset.lensingStrength;
      }
      onWindowResize() {
        const width = this.container.clientWidth;
        const height = this.container.clientHeight;
        this.camera.aspect = width / height;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(width, height);
        this.composer.setSize(width, height);
        this.backgroundRenderTarget.setSize(width * window.devicePixelRatio, height * window.devicePixelRatio);
        this.lensingMaterial.uniforms.u_resolution.value.set(width, height);
      }
      animate() {
        requestAnimationFrame(this.animate.bind(this));
        const elapsedTime = this.clock.getElapsedTime();
        const delta = this.clock.getDelta();
        const scaledTime = elapsedTime * this.rotationSpeedMultiplier; // Update FPS counter
        this.frameCount++;
        if (elapsedTime - this.lastFPSUpdate > 0.5) {
          const fps = Math.round(this.frameCount / (elapsedTime - this.lastFPSUpdate));
          document.getElementById('fps').textContent = `FPS: ${fps}`;
          this.frameCount = 0;
          this.lastFPSUpdate = elapsedTime;
        } // Mettre √† jour les shaders
        this.debrisMaterial.uniforms.u_time.value = scaledTime * 0.1;
        this.accretionDiskMaterial.uniforms.u_time.value = scaledTime * 0.5;
        this.gasCloudGroup.rotation.y = -scaledTime * 0.02;
        this.controls.update(); // PIPELINE DE RENDU OPTIMIS√â // 1. Rendre la sc√®ne de d√©bris dans la texture de fond
        this.renderer.setRenderTarget(this.backgroundRenderTarget);
        this.renderer.clear();
        this.renderer.render(this.backgroundScene, this.camera); // 2. Rendre la sc√®ne finale via le compositeur // (Le lensing lit backgroundRenderTarget, puis le disque est ajout√©)
        this.renderer.setRenderTarget(null);
        this.composer.render(delta);
      }
    }
    new BlackHoleSimulation();
  </script>
</body>

</html>
